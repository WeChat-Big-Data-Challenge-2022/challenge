## 复赛代码提交规范说明

参与复赛的团队均需要提交代码进行审核，截止时间为 8月7日20:00。组委会将审核并剔除只靠人工标注而没有算法贡献、不符合复赛要求、违反比赛规定的队伍。晋级决赛的空缺名额后补，最终通过复赛成绩审核的前6名队伍将晋级全国总决赛。另外，如果TOP6入围决赛的在校学生队伍不足2支队伍，大赛将增补1-2个决赛名额，保证单独排名第一名和第二名的在校学生队伍入围决赛。

### 1. 截止时间

队伍需在北京时间2022年8月7日20:00之前提交代码，逾期未提交的队伍将取消复赛获奖资格和晋级决赛资格。

### 2. 提交方法

比赛的 GPU 环境将于2022年8月5日中午关闭，并启用 CPU 环境供大家整理代码。

复赛代码提交采用 docker 镜像的方式。选手将训练、测试代码打包至 docker 镜像中，并推送到本队伍账号下的镜像仓库中。

提交的 docker 镜像请命名为：tione-wxdsj.tencentcloudcr.com/team-1000xxxxxx/team-xxx:lastsubmit
其中 team-1000xxxxxx 为队伍12位的 id （与复赛阶段提交测试 docker 一致）
镜像名 team-xxx 为三位数字id，001-100

**注意**：复现的 docker 需要包含训练代码，无需包含推理模型的权重。

### 3. 代码目录结构

代码应当置于 docker 镜像的默认工作目录中（`WORKDIR`）。其目录结构如下：

```bash
./
├── README.md             # 代码的说明文档
├── requirements.txt      # Python包依赖文件 
├── Dockerfile            # 构建 Docker 的文件
├── init.sh               # 初始化脚本，用于准备环境
├── train.sh              # 模型训练脚本
├── inference.sh          # 模型测试脚本 
├── src/                  # 核心代码
├── opensource_models/    # 开源的预训练模型文件（例如 bert-base-chinese）。请将权重一并打包进 docker。
```

### 4. 具体说明

1. **README文件**

  需包含代码结构、运行流程说明、算法模型介绍、模型结果等内容。
  如使用了开源的预训练模型（例如 huggingface 上的模型），请在 README 文件中进行说明，并提供开源模型的链接。
  
  在README文件中请注明训练（与预训练）所用的时间（Notebook 双卡环境），以方便复现。

2. **Dockerfile 文件**
  
  构建**复赛代码提交镜像**的 Dockerfile 文件。

3. **环境配置文件**

  运行`bash init.sh`来初始化运行环境，例如某些自定义模块的编译（如有）、视觉特征提取（如有）、数据预处理（如有）

4. **训练和预测脚本** 
  
  请确保对复赛B榜测试集的预测结果可以由提交的训练、预测脚本产出。
  ```bash
  ├── train.sh              # 模型训练脚本
  ├── inference.sh          # 模型测试脚本 
  ```

  如果训练过程中包含多个步骤（如预训练、模型融合等），请按顺序写在 `train.sh` 脚本中，例如
  ```bash
  python src/pretrain.py      # 预训练
  python src/main.py          # 微调权重
  ```
 
 测试脚本 `inference.sh` 与比赛镜像提交中的 `start.sh` 类似，提供了一个测试的入口。如测试过程包含多个步骤，请按顺序书写，例如：
  ```bash
  python src/extract_feature.py      # 提取视觉特征
  python src/inference.py            # 测试程序
  ```


5. **核心代码目录`src/`**
  
  选手需要在此文件夹中存放所有核心代码文件，包括数据预处理、特征预提取、预训练、模型训练和预测等。

  Tips：
  * 提交的核心代码中，具体的文件、目录名可自行命名。
  * 训练阶段（train.sh）需保存模型文件。

6. **开源的预训练模型文件 `opensource_models/`**
  
  选手如使用了开源的预训练模型，请将开源模型的相关文件（模型定义、模型权重）都放置于 `opensource_models/` 目录下，以方便审核，并在 `README.md` 做相关的声明（模型名称、链接）。
  
  注意：复赛**禁止**使用私有模型、或初赛训练好的模型。允许使用开源的词典、embedding和预训练模型，以上数据和模型需在复赛开始，即2022年7月5号（含）之前开源，且需通过邮件的形式报备开源链接地址和md5，报备邮箱为wechat_algo@tencent.com

7. **数据文件**

  请勿在 docker 中打包训练、测试的数据文件。在复现时，数据文件将会挂载到 `/opt/ml/input/data/` 目录下，该目录的具体结构为：

  ```bash
  /opt/ml/input/data/
  ├── annotations/
  │   ├── test.json       # 复赛 B榜 测试集元信息
  │   ├── labeled.json    # 复赛训练有标注 元信息
  │   ├── unlabeled.json  # 复赛训练无标注 元信息
  ├── zip_frames/
  │   ├── test/           # 复赛测试集 B榜 视频帧
  │   ├── labeled/        # 复赛训练有标注 视频帧
  │   ├── unlabeled/      # 复赛训练无标注 视频帧
  ```

### 5. 复现说明

1. 运行环境要求
  * 复现环境与选手训练时所使用的 notebook 环境一致，包含 Intel 18核心CPU、80G内存、2张显卡、1T存储。
2. 官方运行流程
  * 拉取选手提交的镜像
  * 运行 **init.sh**
  * 运行 **train.sh**
  * 计时运行 **inference.sh**。若超时则得分无效。
  * 选手需确保代码执行后生成的测试集的预测结果文件命名为`result.csv` 并保存在 `/opt/ml/output/`目录下
  * 组委会将计算预测结果的评测分数
3. 测试集
  * 组委会将使用B榜测试集，运行推理流程
4. 复现要求
  * 复赛B榜测试集的复现分数，与队伍B榜最终分数需在一定范围（+-0.001）内保持一致；否则，队伍最终分数将以复现结果为准。
  * 通过代码审核要求的前30名队伍才有复赛获奖资格和晋级决赛资格
5. 提示
  * 复现或性能评估过程中若出现任何问题（例如：md5校验失败、运行失败、复现结果不一致、性能不达标），组委会将联系选手进行确认。
  * 若队伍违规或不满足要求，将取消成绩

### 6. 代码下载（可选）

在比赛结束后，选手如有代码下载的需求，可将代码打包放置于 `/home/tione/notebook/code_download/` 目录下。该目录下的结构可由选手自行组织。
**需要注意的是：** 代码下载的目录，仅保留核心代码文件。请勿存放任何数据文件、训练好的模型、或者开源预训练模型的权重。

通过代码审查后，该目录将被推送至腾讯工蜂平台。届时会发放问卷链接收集选手的工蜂账户，并赋予选手账户权限来访问仓库。

### 6. 附录
* 官方baseline已整理为本文档要求的格式供大家参考：https://github.com/WeChat-Big-Data-Challenge-2022/challenge/tree/semi_submission
